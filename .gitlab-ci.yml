stages:
  - init
  - format
  - lint
  - test

init:
  stage: init
  image: snakepacker/python:all
  before_script:
    - apt install python3.10-dev -y
    - python3.10 -m pip install poetry
  script:
    - poetry export -f requirements.txt --output requirements.txt --without-hashes
    - python3.10 -m venv .venv
    - source .venv/bin/activate
    - python -m pip install --no-cache-dir --upgrade -r requirements.txt
  artifacts:
    paths:
      - .venv
    expire_in: 30 minutes

format:
  stage: format
  image: ubuntu:20.04
  needs:
    - init
  before_script:
    - apt update
    - apt install build-essential -y
  script:
    - source .venv/bin/activate
    - make format

lint:
  stage: lint
  image: ubuntu:20.04
  needs:
    - init
    - format
  before_script:
    - apt update
    - apt install build-essential -y
  script:
    - source .venv/bin/activate
    - make lint

test:
  stage: test
  image: ubuntu:20.04
  needs:
    - init
    - format
    - lint
  before_script:
    - apt update
    - apt install build-essential -y
  script:
    - source .venv/bin/activate
    - make test
